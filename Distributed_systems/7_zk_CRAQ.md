## Herd effect of Zookeeper
羊群效应（Herd effect）指的是大量客户端都在等待同一事件，当该事件发生时，它们都会收到通知并试图同时采取行动，从而导致资源消耗大幅飙升。

假设有 1000 个客户端都想获取同一个锁。
1. 所有客户端都尝试创建一个 znode（例如，/lock）。
2. 只有一人成功并保有锁。其他 999 个客户端会监视该节点，/lock以便知道它何时被删除（释放）。
3. ZooKeeper一次性向所有 999 个客户端发送通知。紧急抢占：所有 999 个客户端唤醒并立即向 ZooKeeper 发送请求，以重新创建锁节点。结果：只有一个客户端获得了锁，但 ZooKeeper 领导者突然面临 999 个几乎同时发生的请求。这会导致延迟飙升、网络拥塞和暂时的服务降级。
动物园管理员的解决方案：避开羊群ZooKeeper论文提出了一种更具可扩展性的方法来避免这种情况：
- 每个客户端不监视单个节点，而是创建一个临时的顺序znode. 只有当客户端的序列号最低时，客户端才能获取锁。4如果不是，它只会监视序列中紧邻它的前一个节点。有序交接：当锁被释放时，只会通知一位客户（下一个排队的客户）。5其余 998 位客户仍然“沉睡”，有效消除了羊群效应，并确保$O(1)$每次解锁通知费用。

## `CRAQ`：一种基于 Zookeeper 的分布式队列
- stronger consistency with higher latency tradeoff
- chain structure for replication, instead of Tree structure of ZooKeeper


链式可靠队列（Chain Replication-based Asynchronous Queue，CRAQ）是一种分布式队列系统，利用 ZooKeeper 提供的协调服务来实现高可用性和可靠性。CRAQ 通过将消息存储在多个节点上，并使用链式复制来确保数据的一致性和持久性，从而实现了高效的消息传递机制。

```
[Head] -> [Node1] -> [Node2] -> ... -> [Tail]
```

Write： 当一个消息被写入 CRAQ 队列时，它首先被发送到链的头节点（Head）。头节点负责将消息传递给下一个节点（Node1），然后依次传递到链的尾节点（Tail）。每个节点在接收到消息后都会将其存储并确认，然后将消息传递给下一个节点。这样，消息在链中被复制多次，确保即使某个节点发生故障，消息仍然可以从其他节点恢复。

When write is considered successful?  当链中的大多数节点确认接收到消息后，写操作被认为是成功的。这种机制确保了消息的一致性和持久性，因为即使某些节点失败，消息仍然可以从其他节点恢复。

Read： 消费者从 CRAQ 队列中读取消息时，它们只与链的尾节点（Tail）进行交互。尾节点负责将消息提供给消费者，并在消息被成功处理后将其从链中删除。通过这种方式，消费者可以高效地获取消息，而不需要与整个链进行交互.


Failer Tolerance： CRAQ 利用 ZooKeeper 的协调功能来监控链中的节点状态。如果某个节点发生故障，CRAQ 可以自动重新配置链，确保消息传递的连续性。例如，如果 Node2 失败，Head 将直接将消息传递给 Node3，从而绕过故障节点。ZooKeeper 还可以帮助管理节点的加入和离开，确保链的完整性。